<!DOCTYPE html>
<html lang="">
<head>
    <title>Signalwire Call Harness</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Cross Browser WebRTC Adapter -->
    <script type="text/javascript" src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <!-- Include the SignalWire Relay JS SDK -->
    <script type="text/javascript" src="https://unpkg.com/@signalwire/js@^1"></script>
    <!-- <script type="text/javascript" src="index.min.js"></script> -->
    <!-- To style up the demo a little -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />
    <link rel="shortcut icon" href="https://signalwire.com/assets/images/favicon.ico" />
</head>
<body class="bg-light">
<div class="container">
    <div class="row pt-5">
        <div class="col-12 pb-3">
            <h1>SignalWire Relay Call Test Harness</h1>
            <p>
                This harness allows you to make calls to other browsers, SIP Endpoints or Phone Numbers from your SignalWire project in your browser.
                <br />
                Visit <a href="https://developer.signalwire.com/sdks/browser-sdk/v2/">Relay SDK for JavaScript Documentation</a> for more information and documentation.
            </p>
        </div>
    </div>
    <hr />
    <div class="row py-3">
        <div class="col-12 col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5>Connect</h5>
                    <div class="form-group">
                        <label for="space">Space</label>
                        <input type="text" class="form-control" id="space" placeholder="Enter SignalWire Space (e.g., swoffice)" onchange="saveInLocalStorage(event)">
                        <small class="form-text text-muted">Your SignalWire space name.</small>
                    </div>
                    <div class="form-group">
                        <label for="project">Project</label>
                        <input type="text" class="form-control" id="project" placeholder="Enter Project ID" onchange="saveInLocalStorage(event)">
                        <small id="projectHelp" class="form-text text-muted">Enter the Project ID found on your SignalWire Project Dashboard.</small>
                    </div>
                    <div class="form-group">
                        <label for="apiToken">API Token</label>
                        <input type="text" class="form-control" id="apiToken" placeholder="Enter API Token" onchange="saveInLocalStorage(event)">
                        <small class="form-text text-muted">Your SignalWire API Token (starts with PT...).</small>
                    </div>
                    <div class="form-group">
                        <label for="expiresIn">Expires In (seconds)</label>
                        <input type="number" class="form-control" id="expiresIn" value="3600" onchange="saveInLocalStorage(event)">
                        <small class="form-text text-muted">Token expiration time (default 1 hour).</small>
                    </div>
                    <div class="form-group">
                        <label for="resource">Resource (Identifier)</label>
                        <input type="text" class="form-control" id="resource" value="test-client" onchange="saveInLocalStorage(event)">
                        <small class="form-text text-muted">Identifier for inbound calls (e.g., verto:resource@domain).</small>
                    </div>
                    <div class="form-group">
                        <label for="relayHost">Relay Host (Optional)</label>
                        <input type="text" class="form-control" id="relayHost" placeholder="e.g., relay.swoffice.signalwire.com" onchange="saveInLocalStorage(event)">
                        <small class="form-text text-muted">Custom Relay host (leave empty for default).</small>
                    </div>
                    <button id="btnGenerateToken" class="btn btn-block btn-info" onclick="generateToken()">Generate Token</button>
                    <div class="form-group mt-3">
                        <label for="token">Token</label>
                        <input type="text" class="form-control" id="token" placeholder="Enter or generate your JWT" onchange="saveInLocalStorage(event)">
                        <small id="tokenHelp" class="form-text text-muted">Generated JWT will appear here.</small>
                    </div>
                    <button id="btnConnect" class="btn btn-block btn-success" onclick="connect()">Connect</button>
                    <button id="btnDisconnect" class="btn btn-block btn-danger d-none" onclick="disconnect()">Disconnect</button>
                    <div class="text-center mt-3 text-muted">
                        <small>Status: <span id='connectStatus'>Not Connected</span></small>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <h5>Call State</h5>
                    <small>Status: <span id='callStatus'>None</span></small>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-8 mt-4 mt-md-1">
            <div class="row">
                <div class="col-6">
                    <h5>Local Video</h5>
                    <video id="localVideo" autoplay="true" class="w-100" style="background-color: #000; border: 1px solid #ccc; border-radius: 5px;"></video>
                </div>
                <div class="col-6">
                    <h5>Remote Video</h5>
                    <video id="remoteVideo" autoplay="true" class="w-100" playsinline style="background-color: #000; border: 1px solid #ccc; border-radius: 5px;"></video>
                </div>
            </div>
            <div class="form-group">
                <label for="number">Call To:</label>
                <input type="text" class="form-control" id="number" placeholder="Enter Resource or Number to Dial" onchange="saveInLocalStorage(event)">
                <label for="numberFrom">Call From:</label>
                <input type="text" class="form-control" id="numberFrom" placeholder="Enter Source number to Call From" onchange="saveInLocalStorage(event)">
            </div>
            <div>Call Options:</div>
            <div class="form-check">
                <input type="checkbox" id="audio" value="1" onchange="saveInLocalStorage(event)">
                <label class="form-check-label" for="audio">
                    Include Audio
                </label>
            </div>
            <div class="form-check">
                <input type="checkbox" id="video" value="1" onchange="saveInLocalStorage(event)">
                <label class="form-check-label" for="video">
                    Include Video
                </label>
            </div>
            <button id="startCall" class="btn btn-primary px-5 mt-4" onClick="makeCall()" disabled="true">Call</button>
            <button id="hangupCall" class="btn btn-danger px-5 mt-4 d-none" onClick="hangup()" disabled="true">Hang up</button>
            <button id="restartIce" class="btn btn-warning px-5 mt-4 d-none" onClick="restartIceCall()" disabled="true">Restart ICE</button>
            <div class="form-group mt-4">
                <label for="logArea">Logs</label>
                <textarea id="logArea" class="form-control" rows="8" readonly style="font-family: monospace; font-size: 12px; background-color: #f8f9fa;"></textarea>
                <button id="btnClearLogs" class="btn btn-sm btn-secondary mt-2" onclick="clearLogs()">Clear Logs</button>
            </div>
            <div class="form-group" id="dtmfKeys" hidden="false">
                <button id="dtmf_1" class="btn btn-primary px-2 mt-4" onClick="dtmf()">1</button>
                <button id="dtmf_2" class="btn btn-primary px-2 mt-4" onClick="dtmf()">2</button>
                <button id="dtmf_3" class="btn btn-primary px-2 mt-4" onClick="dtmf()">3</button>
                <button id="dtmf_4" class="btn btn-primary px-2 mt-4" onClick="dtmf()">4</button>
                <button id="dtmf_5" class="btn btn-primary px-2 mt-4" onClick="dtmf()">5</button>
                <button id="dtmf_6" class="btn btn-primary px-2 mt-4" onClick="dtmf()">6</button>
                <button id="dtmf_7" class="btn btn-primary px-2 mt-4" onClick="dtmf()">7</button>
                <button id="dtmf_8" class="btn btn-primary px-2 mt-4" onClick="dtmf()">8</button>
                <button id="dtmf_9" class="btn btn-primary px-2 mt-4" onClick="dtmf()">9</button>
                <button id="dtmf_0" class="btn btn-primary px-2 mt-4" onClick="dtmf()">0</button>
                <button id="dtmf_hash" class="btn btn-primary px-2 mt-4" onClick="dtmf()">#</button>
                <button id="dtmf_star" class="btn btn-primary px-2 mt-4" onClick="dtmf()">*</button>
                <button id="dtmf_a" class="btn btn-primary px-2 mt-4" onClick="dtmf()">A</button>
                <button id="dtmf_b" class="btn btn-primary px-2 mt-4" onClick="dtmf()">B</button>
                <button id="dtmf_c" class="btn btn-primary px-2 mt-4" onClick="dtmf()">C</button>
                <button id="dtmf_d" class="btn btn-primary px-2 mt-4" onClick="dtmf()">D</button>
            </div>
        </div>
    </div>
    <hr />
    <div class="row pt-3 pb-5">
        <h3 class="mb-3">Instructions</h3>
        <ol>
            <li>Fill in your SignalWire Space, Project ID, and API Token.</li>
            <li>Click "Generate Token" to create a JWT (it will populate the Token field).</li>
            <li>Click "Connect" to connect to SignalWire.</li>
            <li>Fill in call details and click "Call" to start a call.</li>
        </ol>
        <div class="col-12">
            <h4>Troubleshooting</h4>
            <p>If you notice any JavaScript errors in the console relating to <code>localStorage</code>, try unblocking 3rd Party Cookies. Some browsers mark localStorage Cookies as 3rd Party when being run from <code>file://</code>.</p>
            <p>For token generation errors, check the console and ensure your credentials are correct. Note: Token generation from browser may be blocked by CORS; if so, use curl and paste the token manually.</p>
        </div>
    </div>
    <script type="text/javascript">
        var client;
        var currentCall = null;
        var project = localStorage.getItem('relay.example.project') || '';
        var token = localStorage.getItem('relay.example.token') || '';
        var number = localStorage.getItem('relay.example.number') || '';
        var numberFrom = localStorage.getItem('relay.example.numberFrom') || '';
        var audio = localStorage.getItem('relay.example.audio') || '1';
        var video = localStorage.getItem('relay.example.video') || '1';
        var space = localStorage.getItem('relay.example.space') || '';
        var apiToken = localStorage.getItem('relay.example.apiToken') || '';
        var expiresIn = localStorage.getItem('relay.example.expiresIn') || '3600';
        var resource = localStorage.getItem('relay.example.resource') || 'test-client';
        var relayHost = localStorage.getItem('relay.example.relayHost') || '';
        const getCircularReplacer = () => {
            const seen = new WeakSet();
            return (key, value) => {
                if (typeof value === "object" && value !== null) {
                    if (seen.has(value)) {
                        return;
                    }
                    seen.add(value);
                }
                return value;
            };
        };
        /**
         * Add a log entry to the log area
         */
        function addLog(message) {
            const logArea = document.getElementById('logArea');
            if (logArea) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `[${timestamp}] ${message}\n`;
                logArea.value += logEntry;
                logArea.scrollTop = logArea.scrollHeight;
            }
        }
        /**
         * Clear all logs
         */
        function clearLogs() {
            const logArea = document.getElementById('logArea');
            if (logArea) {
                logArea.value = '';
                addLog('Logs cleared');
            }
        }
        /**
         * On document ready auto-fill the input values from the localStorage.
         */
        ready(function() {
            document.getElementById('space').value = space;
            document.getElementById('project').value = project;
            document.getElementById('apiToken').value = apiToken;
            document.getElementById('expiresIn').value = expiresIn;
            document.getElementById('resource').value = resource;
            document.getElementById('relayHost').value = relayHost;
            document.getElementById('token').value = token;
            document.getElementById('number').value = number;
            document.getElementById('numberFrom').value = numberFrom;
            document.getElementById('audio').checked = audio === '1';
            document.getElementById('video').checked = video === '1';
            addLog('Application initialized. Ready to connect.');
        });
        /**
         * Generate JWT token using fetch
         */
        async function generateToken() {
            let spaceVal = document.getElementById('space').value.trim();
            const projectVal = document.getElementById('project').value.trim();
            const apiTokenVal = document.getElementById('apiToken').value.trim();
            const expiresInVal = document.getElementById('expiresIn').value;
            const resourceVal = document.getElementById('resource').value.trim();

            if (!spaceVal || !projectVal || !apiTokenVal) {
                addLog('ERROR: Please fill in Space, Project ID, and API Token.');
                alert('Please fill in Space, Project ID, and API Token.');
                return;
            }

            // Clean spaceVal if it has https://
            spaceVal = spaceVal.replace(/^https?:\/\//, '');
            
            // Determine if it's a custom domain or needs .signalwire.com
            let apiUrl;
            if (spaceVal.includes('.') && !spaceVal.endsWith('.signalwire.com')) {
                // Custom domain (e.g., dev.swire.io)
                apiUrl = `https://${spaceVal}/api/relay/rest/jwt`;
                addLog(`Using custom domain: ${spaceVal}`);
            } else {
                // Standard SignalWire domain
                spaceVal = spaceVal.replace(/\.signalwire\.com$/, '');
                apiUrl = `https://${spaceVal}.signalwire.com/api/relay/rest/jwt`;
                addLog(`Using SignalWire domain: ${spaceVal}.signalwire.com`);
            }

            const body = {
                expires_in: parseInt(expiresInVal),
                resource: resourceVal
            };
            const auth = btoa(`${projectVal}:${apiTokenVal}`);

            addLog(`Generating token for resource: ${resourceVal}, expires in: ${expiresInVal}s`);
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Basic ${auth}`
                    },
                    body: JSON.stringify(body)
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }
                const data = await response.json();
                document.getElementById('token').value = data.jwt_token;
                saveInLocalStorage({ target: { id: 'token', value: data.jwt_token } });
                addLog('SUCCESS: Token generated successfully');
                console.log('Token generated successfully');
            } catch (error) {
                const errorMsg = `ERROR: Failed to generate token - ${error.message}`;
                addLog(errorMsg);
                console.error('Error generating token:', error);
                alert('Failed to generate token. Check console and logs for details. Note: This may be due to CORS restrictions; try using curl instead.');
            }
        }
        /**
         * Connect with Relay creating a client and attaching all the event handler.
         */
        function connect() {
            const projectVal = document.getElementById('project').value;
            const tokenVal = document.getElementById('token').value;
            const relayHostVal = document.getElementById('relayHost').value.trim();
            
            if (!projectVal || !tokenVal) {
                addLog('ERROR: Project ID and Token are required to connect.');
                alert('Please fill in Project ID and Token.');
                return;
            }

            const relayConfig = {
                project: projectVal,
                token: tokenVal
            };

            if (relayHostVal) {
                relayConfig.host = relayHostVal;
                addLog(`Using custom Relay host: ${relayHostVal}`);
            } else {
                addLog('Using default Relay host');
            }

            client = new Relay(relayConfig);
            // client.autoRecoverCalls = false;
            client.remoteElement = 'remoteVideo';
            client.localElement = 'localVideo';
            // client.iceServers = [{ urls: ['stun:stun.l.google.com:19302'] }];
            if (document.getElementById('audio').checked) {
                client.enableMicrophone()
            } else {
                client.disableMicrophone()
            }
            if (document.getElementById('video').checked) {
                client.enableWebcam()
            } else {
                client.disableWebcam()
            }
            client.on('signalwire.ready', function() {
                btnConnect.classList.add('d-none');
                btnDisconnect.classList.remove('d-none');
                connectStatus.innerHTML = 'Connected';
                startCall.disabled = false;
                addLog('SUCCESS: Connected to SignalWire Relay');
            });
            // Update UI on socket close
            client.on('signalwire.socket.close', function() {
                btnConnect.classList.remove('d-none');
                btnDisconnect.classList.add('d-none');
                connectStatus.innerHTML = 'Disconnected';
                addLog('INFO: Disconnected from SignalWire Relay');
            });
            // Handle error...
            client.on('signalwire.error', function(error){
                const errorMsg = `ERROR: SignalWire error - Code: ${error.code}, Message: ${error.message}`;
                addLog(errorMsg);
                console.error("SignalWire error:", error);
            });
            client.on('signalwire.notification', handleNotification);
            connectStatus.innerHTML = 'Connecting...';
            addLog('Connecting to SignalWire Relay...');
            client.connect();
        }
        function disconnect() {
            connectStatus.innerHTML = 'Disconnecting...';
            addLog('Disconnecting from SignalWire Relay...');
            client.disconnect();
        }
        /**
         * Handle notification from the client.
         */
        function handleNotification(notification) {
            console.log("notification", notification.type, notification);
            switch (notification.type) {
                case 'callUpdate':
                    handleCallUpdate(notification.call);
                    break;
                case 'userMediaError':
                    addLog('ERROR: User media error - Permission denied or invalid audio/video params');
                    break;
            }
        }
        /**
         * Update the UI when the call's state change
         */
        function handleCallUpdate(call) {
            currentCall = call;
            let ccallState = JSON.parse(JSON.stringify(call,getCircularReplacer()));
            console.log(currentCall.state,currentCall.cause,currentCall.causeCode);
            console.log("Call State: " ,ccallState);
            let msg = currentCall.causeCode ? `Code:${currentCall.causeCode} Reason: ${currentCall.cause}` : `Early Media:${currentCall.gotEarly} Answered: ${currentCall.gotAnswer}`;
            callStatus.innerHTML = `${currentCall.prevState} -> ${currentCall.state} </br> ${msg}`;
            addLog(`Call state: ${currentCall.prevState} -> ${currentCall.state}${currentCall.causeCode ? ` (Code: ${currentCall.causeCode}, Reason: ${currentCall.cause})` : ''}`);
            switch (call.state) {
                case 'new': // Setup the UI
                    break;
                case 'trying': // You are trying to call someone and he's ringing now
                    startCall.classList.add('d-none');
                    hangupCall.classList.remove('d-none');
                    hangupCall.disabled = false;
                    dtmfKeys.hidden=false;
                    restartIce.classList.add('d-none');
                    restartIce.disabled = true;
                    break;
                case 'recovering': // Call is recovering from a previous session
                    if (confirm('Recover the previous call?')) {
                        currentCall.answer();
                    } else {
                        currentCall.hangup();
                    }
                    break;
                case 'ringing': // Someone is calling you
                    if (confirm('Pick up the call?')) {
                        currentCall.answer();
                    } else {
                        currentCall.hangup();
                    }
                    break;
                case 'active': // Call has become active
                    startCall.classList.add('d-none');
                    hangupCall.classList.remove('d-none');
                    hangupCall.disabled = false;
                    restartIce.classList.remove('d-none');
                    restartIce.disabled = false;
                    dtmfKeys.hidden=false;
                    break;
                case 'hangup': // Call is over
                    startCall.classList.remove('d-none');
                    hangupCall.classList.add('d-none');
                    hangupCall.disabled = true;
                    restartIce.classList.add('d-none');
                    restartIce.disabled = true;
                    dtmfKeys.hidden=true;
                    break;
                case 'destroy': // Call has been destroyed
                    currentCall = null;
                    restartIce.classList.add('d-none');
                    restartIce.disabled = true;
                    break;
            }
        }
        /**
         * Make a new outbound call
         */
        function makeCall() {
            const destination = document.getElementById('number').value;
            const caller = document.getElementById('numberFrom').value;
            const audioEnabled = document.getElementById('audio').checked;
            const videoEnabled = document.getElementById('video').checked;
            
            if (!destination) {
                addLog('ERROR: Please enter a destination number or resource');
                alert('Please enter a destination number or resource');
                return;
            }

            const params = {
                destinationNumber: destination,
                callerNumber: caller,
                audio: audioEnabled,
                video: videoEnabled ? { aspectRatio: 16/9 } : false,
            };
            
            addLog(`Initiating call to: ${destination}${caller ? ` from: ${caller}` : ''} (Audio: ${audioEnabled ? 'Yes' : 'No'}, Video: ${videoEnabled ? 'Yes' : 'No'})`);
            currentCall = client.newCall(params);
        }
        /**
         * Restart ICE on the current call
         */
        function restartIceCall() {
            if (currentCall) {
                addLog('INFO: Restarting ICE connection...');
                currentCall.peer.instance.restartIce();
                console.log("restartIce called");
                addLog('SUCCESS: ICE restart initiated');
            } else {
                addLog('ERROR: No active call to restart ICE');
            }
        }
        /**
         * Send a DTMF to currentCall if present
         */
        function dtmf() {
            if (currentCall) {
                let dtmfkey = event.srcElement.id;
                console.log(dtmfkey);
                switch (dtmfkey) {
                    case 'dtmf_0':
                        currentCall.dtmf('0');
                        break;
                    case 'dtmf_1':
                        currentCall.dtmf('1');
                        break;
                    case 'dtmf_2':
                        currentCall.dtmf('2');
                        break;
                    case 'dtmf_3':
                        currentCall.dtmf('3');
                        break;
                    case 'dtmf_4':
                        currentCall.dtmf('4');
                        break;
                    case 'dtmf_5':
                        currentCall.dtmf('5');
                        break;
                    case 'dtmf_6':
                        currentCall.dtmf('6');
                        break;
                    case 'dtmf_7':
                        currentCall.dtmf('7');
                        break;
                    case 'dtmf_8':
                        currentCall.dtmf('8');
                        break;
                    case 'dtmf_9':
                        currentCall.dtmf('9');
                        break;
                    case 'dtmf_hash':
                        currentCall.dtmf('#');
                        break;
                    case 'dtmf_star':
                        currentCall.dtmf('*');
                        break;
                    case 'dtmf_a':
                        currentCall.dtmf('a');
                        break;
                    case 'dtmf_b':
                        currentCall.dtmf('b');
                        break;
                    case 'dtmf_c':
                        currentCall.dtmf('c');
                        break;
                    case 'dtmf_d':
                        currentCall.dtmf('d');
                        break;
                    default:
                        console.log("unknown dtmf");
                }
            }
        }
        /**
         * Hangup the currentCall if present
         */
        function hangup() {
            if (currentCall) {
                addLog('Hanging up call...');
                currentCall.hangup()
            }
        }
        function saveInLocalStorage(e) {
            var key = e.target.name || e.target.id
            localStorage.setItem('relay.example.' + key, e.target.value);
        }
        // jQuery document.ready equivalent
        function ready(callback) {
            if (document.readyState != 'loading') {
                callback();
            } else if (document.addEventListener) {
                document.addEventListener('DOMContentLoaded', callback);
            } else {
                document.attachEvent('onreadystatechange', function() {
                    if (document.readyState != 'loading') {
                        callback();
                    }
                });
            }
        }
    </script>
</div>
</body>
</html>