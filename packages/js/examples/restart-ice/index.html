<!DOCTYPE html>
<html lang="en">
<head>
    <title>SignalWire ICE Restart Harness (Dual Log + Debug)</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script type="text/javascript" src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script type="text/javascript" src="signalwire.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />
</head>
<body class="bg-light">
<div class="container">
    <div class="row pt-5">
        <div class="col-12 pb-3">
            <h3>SignalWire ICE Restart Demo</h3>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Credentials</h5>
                    <input type="text" id="space" class="form-control mb-2" placeholder="Space URL">
                    <input type="text" id="project" class="form-control mb-2" placeholder="Project ID">
                    <input type="text" id="apiToken" class="form-control mb-2" placeholder="API Token">
                    <input type="text" id="resource" class="form-control mb-2" placeholder="Resource Name" value="test-client">
                    
                    <button class="btn btn-info btn-block" onclick="generateToken()">Generate Token</button>
                    <hr>
                    <input type="text" id="token" class="form-control mb-2" placeholder="JWT Token">
                    <button class="btn btn-success btn-block" onclick="connect()">Connect Relay (Debug)</button>
                    <button class="btn btn-danger btn-block d-none" id="btnDisconnect" onclick="disconnect()">Disconnect</button>
                    <div class="mt-2 small text-center">Status: <strong id="connectStatus">Disconnected</strong></div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">Call</h5>
                    <input type="text" id="number" class="form-control mb-2" placeholder="Call To">
                    <input type="text" id="numberFrom" class="form-control mb-2" placeholder="Call From">
                    
                    <div class="mt-2">
                        <div class="form-check form-check-inline mr-3">
                            <input type="checkbox" class="form-check-input" id="audio" checked>
                            <label class="form-check-label" for="audio">Audio</label>
                        </div>
                        <div class="form-check form-check-inline mr-3">
                            <input type="checkbox" class="form-check-input" id="video" checked>
                            <label class="form-check-label" for="video">Video</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input type="checkbox" class="form-check-input" id="autoAnswer" checked>
                            <label class="form-check-label" for="autoAnswer">AutoAnswer</label>
                        </div>
                    </div>

                    <button id="startCall" class="btn btn-primary btn-block mt-3" onclick="makeCall()" disabled>Call</button>
                    <button id="hangupCall" class="btn btn-danger btn-block mt-2 d-none" onclick="hangup()">Hangup</button>
                </div>
            </div>

            <button id="btnRestartIce" class="btn btn-warning btn-block mt-4" onclick="triggerIceRestart(true)" disabled>
                Force Restart ICE
            </button>
            <div class="form-check mt-3">
                <input type="checkbox" class="form-check-input" id="autoRestartIce" checked>
                <label class="form-check-label" for="autoRestartIce">
                    Auto Restart ICE on FAILED (SDK)
                </label>
            </div>
        </div>

        <div class="col-md-8">
            <div class="row">
                <div class="col-6">
                    <span class="badge badge-dark mb-1">Local</span>
                    <video id="localVideo" autoplay playsinline muted style="width:100%; background:#000; border-radius:4px;"></video>
                </div>
                <div class="col-6">
                    <span class="badge badge-dark mb-1">Remote</span>
                    <video id="remoteVideo" autoplay playsinline style="width:100%; background:#000; border-radius:4px;"></video>
                </div>
            </div>
            <textarea id="logArea" class="form-control mt-3" rows="12" style="font-family: monospace; font-size: 11px; color: #333; background: #f8f9fa;"></textarea>
        </div>
    </div>
</div>

<script>
    var client;
    var currentCall = null;
    var restartLock = false;
    var pendingRestart = false;

    function loadState() {
        ['space', 'project', 'apiToken', 'resource', 'token', 'number', 'numberFrom'].forEach(id => {
            var val = localStorage.getItem('relay.' + id);
            if(val) document.getElementById(id).value = val;
        });
    }
    loadState();

    function saveState(e) {
        if(e && e.target) localStorage.setItem('relay.' + e.target.id, e.target.value);
    }
    document.querySelectorAll('input').forEach(el => el.onchange = saveState);

    function log(msg) {
        var area = document.getElementById('logArea');
        var time = new Date().toLocaleTimeString();
        area.value += `[${time}] ${msg}\n`;
        area.scrollTop = area.scrollHeight;
        console.log(`[APP] ${msg}`);
    }

    async function generateToken() {
        var space = document.getElementById('space').value.replace(/https?:\/\//, '').replace(/\/$/, '');
        var project = document.getElementById('project').value;
        var apiToken = document.getElementById('apiToken').value;
        var resource = document.getElementById('resource').value || 'test-client';

        if(!space || !project || !apiToken) return alert("Fill Space, Project, API Token");
        if(!space.includes('signalwire.com')) space += '.signalwire.com';

        log(`Generating token for: ${resource}...`);
        var auth = btoa(project + ':' + apiToken);

        try {
            var res = await fetch(`https://${space}/api/relay/rest/jwt`, {
                method: 'POST',
                headers: { 'Authorization': 'Basic ' + auth, 'Content-Type': 'application/json' },
                body: JSON.stringify({ resource: resource, expires_in: 3600 })
            });
            
            if(!res.ok) throw new Error(await res.text());
            var data = await res.json();
            
            document.getElementById('token').value = data.jwt_token;
            localStorage.setItem('relay.token', data.jwt_token);
            log("Token Generated!");
        } catch(e) {
            log("Token Error: " + e.message);
        }
    }

    function connect() {
        var p = document.getElementById('project').value;
        var t = document.getElementById('token').value;
        if(!p || !t) return alert("Project and Token required");

        client = new Relay({ 
            project: p, 
            token: t
        });

        client.remoteElement = 'remoteVideo';
        client.localElement = 'localVideo';
        client.disableTcpIceServers = true;  // use only UDP (no transport=tcp)

        if (client.__logger && client.__logger.setLevel && client.__logger.levels) {
            client.__logger.setLevel(client.__logger.levels.DEBUG);
            log("SDK logger set to DEBUG.");
        }

        if(document.getElementById('audio').checked) client.enableMicrophone();
        if(document.getElementById('video').checked) client.enableWebcam();

        client.on('signalwire.ready', () => {
            document.getElementById('connectStatus').innerText = "Connected";
            document.getElementById('startCall').disabled = false;
            document.getElementById('btnDisconnect').classList.remove('d-none');
            log("Relay Connected.");

            if (pendingRestart) {
                log("Socket recovered. Executing pending restart...");
                triggerIceRestart(true); 
            }
        });

        client.on('signalwire.socket.close', () => {
            log("Socket Closed.");
            document.getElementById('connectStatus').innerText = "Disconnected";
        });

        client.on('signalwire.error', (e) => log("Error: " + e.message));
        client.on('signalwire.notification', (n) => {
            if(n.type === 'callUpdate') handleCallUpdate(n.call);
        });

        log("Connecting (DEBUG MODE)...");
        if (typeof BUILD_ID !== 'undefined') log("SDK Build: " + BUILD_ID);
        client.connect();
    }

    function disconnect() {
        if(client) client.disconnect();
        document.getElementById('connectStatus').innerText = "Disconnected";
    }

    function makeCall() {
        var dest = document.getElementById('number').value;
        var src = document.getElementById('numberFrom').value;
        var useVideo = document.getElementById('video').checked;

        if (!dest) return alert("Please enter a destination number");
        if (!src) src = "1234567890"; 

        var params = {
            destinationNumber: dest,
            callerNumber: src,
            audio: document.getElementById('audio').checked,
            video: useVideo ? { aspectRatio: 16/9 } : false
        };
        
        log("Calling...");
        currentCall = client.newCall(params);
    }

    function hangup() {
        if(currentCall) currentCall.hangup();
    }

    function handleCallUpdate(call) {
        currentCall = call;
        log(`State Change: ${call.state}`);

        if (call.state === 'ringing') {
            if (document.getElementById('autoAnswer').checked) {
                log("Auto-Answering...");
                var answerParams = {
                    audio: document.getElementById('audio').checked,
                    video: document.getElementById('video').checked ? { aspectRatio: 16/9 } : false
                };
                
                var p = currentCall.answer(answerParams);
                if (p && typeof p.catch === 'function') {
                    p.catch(e => log("Answer Warning: " + e.message));
                }
            }
        }
        else if (call.state === 'active') {
            document.getElementById('startCall').classList.add('d-none');
            document.getElementById('hangupCall').classList.remove('d-none');
            document.getElementById('btnRestartIce').disabled = false;
            restartLock = false;
            pendingRestart = false;
            

            if (document.getElementById('autoRestartIce').checked && currentCall && currentCall.options) {
                currentCall.options.autoRestartIceOnFailure = true;
                currentCall.options.maxIceRestartAttempts = 3;
                log("Auto Restart ICE: ENABLED (SDK listening for ICE 'failed').");
            }
            
            var pc = call.peer.instance;

            if (pc && pc.addEventListener) {
                pc.addEventListener('iceconnectionstatechange', function () {
                    var state = pc.iceConnectionState;
                    log(`[ICE State] Changed to: ${state}`);
                    if (state === 'failed') {
                        log("ICE FAILED! Check if the SDK logs restart attempt in the console.");
                    }
                });
            }


            pc.onconnectionstatechange = function() {
                var state = pc.connectionState;
                log(`[Conn State] Changed to: ${state}`);
            };
        }
        else if (call.state === 'hangup' || call.state === 'destroy') {
            document.getElementById('startCall').classList.remove('d-none');
            document.getElementById('hangupCall').classList.add('d-none');
            document.getElementById('btnRestartIce').disabled = true;
            restartLock = false;
            pendingRestart = false;
        }
    }

    function triggerIceRestart(force) {
        if (restartLock && !force) {
            console.warn("Restart blocked: Already in progress.");
            return;
        }
        
        if (!currentCall) return log("No active call.");
        
        restartLock = true;
        log("Manual ICE Restart triggered...");
        
        try {
            currentCall.restartIce();
            log("restartIce() called.");
        } catch (e) {
            log("Restart Exception: " + e);
        }

        setTimeout(() => { restartLock = false; }, 5000);
    }
</script>
</body>
</html>